<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Isekai Adventure</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=MedievalSharp&display=swap"
    rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
      color: #e2e8f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 1rem;
      position: relative;
      overflow-x: hidden;
    }

    /* Animated background particles */
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
      z-index: 1;
    }

    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      animation: float 20s infinite linear;
    }

    @keyframes float {
      from {
        transform: translateY(100vh) translateX(0);
        opacity: 0;
      }

      10% {
        opacity: 1;
      }

      90% {
        opacity: 1;
      }

      to {
        transform: translateY(-100vh) translateX(100px);
        opacity: 0;
      }
    }

    .game-container {
      background: rgba(45, 55, 72, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 1rem;
      padding: 2.5rem;
      box-shadow:
        0 20px 25px -5px rgba(0, 0, 0, 0.3),
        0 10px 10px -5px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
      width: 100%;
      max-width: 700px;
      text-align: center;
      position: relative;
      z-index: 10;
      animation: fadeIn 1s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header-title {
      font-family: 'MedievalSharp', cursive;
      font-size: 3rem;
      background: linear-gradient(135deg, #f6e05e 0%, #f687b3 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 2rem;
      text-shadow: 0 0 30px rgba(246, 224, 94, 0.5);
      animation: glow 2s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from {
        filter: drop-shadow(0 0 20px rgba(246, 224, 94, 0.5));
      }

      to {
        filter: drop-shadow(0 0 30px rgba(246, 224, 94, 0.8));
      }
    }

    .story-text {
      font-family: 'MedievalSharp', cursive;
      font-size: 1.25rem;
      line-height: 1.8;
      margin-bottom: 2rem;
      color: #e2e8f0;
      min-height: 120px;
      padding: 1.5rem;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 0.5rem;
      border: 1px solid rgba(255, 255, 255, 0.05);
      position: relative;
      animation: textFade 0.5s ease-out;
    }

    @keyframes textFade {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .choices-container {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      align-items: center;
    }

    .choices-container button {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem 2rem;
      border-radius: 0.5rem;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      width: 100%;
      max-width: 400px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .choices-container button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .choices-container button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .choices-container button:hover::before {
      left: 100%;
    }

    .choices-container button:active {
      transform: translateY(0);
    }

    .message-box {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      padding: 1rem 2rem;
      border-radius: 0.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      z-index: 100;
      display: none;
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      animation: slideDown 0.5s ease-out;
    }

    @keyframes slideDown {
      from {
        transform: translateX(-50%) translateY(-100%);
        opacity: 0;
      }

      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    .inventory-display {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: rgba(0, 0, 0, 0.3);
      padding: 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 0.875rem;
      max-width: 150px;
    }

    .inventory-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #f6e05e;
      font-family: 'MedievalSharp', cursive;
    }

    .inventory-item {
      padding: 0.25rem 0;
      color: #cbd5e1;
      font-size: 0.75rem;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #f6e05e;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Mobile responsiveness */
    @media (max-width: 640px) {
      .header-title {
        font-size: 2rem;
      }

      .story-text {
        font-size: 1.1rem;
        padding: 1rem;
      }

      .game-container {
        padding: 1.5rem;
      }

      .inventory-display {
        position: static;
        margin-bottom: 1rem;
        max-width: 100%;
      }
    }
  </style>
</head>

<body>
  <!-- Animated particles background -->
  <div class="particles" id="particles"></div>

  <div id="messageBox" class="message-box"></div>

  <div class="game-container">
    <div class="inventory-display" id="inventoryDisplay">
      <div class="inventory-title">Inventory</div>
      <div id="inventoryList">Empty</div>
    </div>

    <h1 class="header-title">Another Realm</h1>
    <div id="story" class="story-text">
      <div class="loading-spinner"></div> Loading your destiny...
    </div>
    <div id="choices" class="choices-container"></div>
  </div>

  <script>
    // Create animated particles
    function createParticles() {
      const particlesContainer = document.getElementById('particles');
      const particleCount = 50;

      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 20 + 's';
        particle.style.animationDuration = (15 + Math.random() * 10) + 's';
        particlesContainer.appendChild(particle);
      }
    }

    // --- Game State and Story Data ---
    let currentStage = 'start';
    let inventory = [];

    const storyTree = {
      'start': {
        text: "You're walking home after a long day, mindlessly scrolling on your phone. Suddenly, a blinding turquoise light erupts from an old, forgotten alleyway. Curiosity, or perhaps an unseen force, pulls you closer.",
        choices: [
          { text: "Investigate the light", nextStage: 'intoTheLight' },
          { text: "Ignore it and walk faster", nextStage: 'ignoreLight' }
        ]
      },
      'ignoreLight': {
        text: "You try to quicken your pace, a sense of unease washing over you. But the light intensifies, engulfing your vision. The world spins, and then... darkness.",
        choices: [
          { text: "Wake up...", nextStage: 'awakeningForest' }
        ]
      },
      'intoTheLight': {
        text: "Drawn by an irresistible pull, you step into the alley. The light is warm, pulsating. As you reach its source – a shimmering, swirling portal – you feel a gentle tug, then a dizzying rush. The world dissolves around you.",
        choices: [
          { text: "Open your eyes...", nextStage: 'awakeningForest' }
        ]
      },
      'awakeningForest': {
        text: "You awaken with a gasp, lying on a bed of soft moss. Towering, luminous trees surround you, their leaves glowing with an ethereal light. Strange, melodic bird calls echo in the distance. This is not your world. What do you do?",
        choices: [
          { text: "Look for signs of civilization", nextStage: 'seekCivilization' },
          { text: "Examine your immediate surroundings", nextStage: 'examineForest' },
          { text: "Shout for help", nextStage: 'shoutForHelp' }
        ]
      },
      'examineForest': {
        text: "You carefully scan the area. The plants are unlike anything you've seen, some pulsing with faint light. You spot a peculiar, shimmering fruit on a low-hanging branch. Nearby, a small, almost hidden path winds deeper into the woods.",
        choices: [
          { text: "Take the shimmering fruit", nextStage: 'takeFruit', condition: () => !inventory.includes('Shimmering Fruit') },
          { text: "Follow the hidden path", nextStage: 'followPath' },
          { text: "Go back to the clearing", nextStage: 'awakeningForest' }
        ]
      },
      'takeFruit': {
        text: "You pluck the fruit. It feels warm and tingles slightly in your hand. You've acquired a 'Shimmering Fruit'.",
        onEnter: () => {
          if (!inventory.includes('Shimmering Fruit')) {
            inventory.push('Shimmering Fruit');
            showMessage("Item Acquired: Shimmering Fruit!");
            updateInventoryDisplay();
          }
        },
        choices: [
          { text: "Continue examining surroundings", nextStage: 'examineForestPostFruit' },
          { text: "Eat the fruit now", nextStage: 'eatFruit' }
        ]
      },
      'examineForestPostFruit': {
        text: "You continue to scan the area. The plants are unlike anything you've seen. The small, hidden path winds deeper into the woods.",
        choices: [
          { text: "Follow the hidden path", nextStage: 'followPath' },
          { text: "Go back to the clearing", nextStage: 'awakeningForest' }
        ]
      },
      'eatFruit': {
        text: "You take a bite of the Shimmering Fruit. A wave of warmth and clarity washes over you. You feel slightly more attuned to this strange world, your senses sharpened.",
        onEnter: () => {
          inventory = inventory.filter(item => item !== 'Shimmering Fruit');
          showMessage("You feel invigorated!");
          updateInventoryDisplay();
        },
        choices: [
          { text: "Continue exploring", nextStage: 'examineForestPostFruit' }
        ]
      },
      'shoutForHelp': {
        text: "You cup your hands and yell, 'Hello? Is anyone out there?!' Your voice echoes, but only the strange bird calls answer. A moment later, you hear a rustling in the undergrowth nearby.",
        choices: [
          { text: "Investigate the rustling", nextStage: 'investigateRustling' },
          { text: "Stay quiet and observe", nextStage: 'observeRustling' }
        ]
      },
      'investigateRustling': {
        text: "You cautiously approach the source of the sound. A small, furry creature with large, curious eyes peeks out from behind a bush. It tilts its head, then scurries away, dropping a small, intricately carved wooden token.",
        choices: [
          { text: "Pick up the token", nextStage: 'takeToken' },
          { text: "Leave it and continue", nextStage: 'awakeningForest' }
        ]
      },
      'takeToken': {
        text: "You pick up the wooden token. It feels smooth and strangely comforting. You've acquired a 'Carved Token'.",
        onEnter: () => {
          if (!inventory.includes('Carved Token')) {
            inventory.push('Carved Token');
            showMessage("Item Acquired: Carved Token!");
            updateInventoryDisplay();
          }
        },
        choices: [
          { text: "Continue exploring the forest", nextStage: 'awakeningForest' }
        ]
      },
      'observeRustling': {
        text: "You remain still, watching. A small, furry creature with large, curious eyes emerges, glances in your direction, then darts off into the forest. It seems harmless.",
        choices: [
          { text: "Continue exploring", nextStage: 'awakeningForest' }
        ]
      },
      'seekCivilization': {
        text: "You decide to find others. Which direction seems most promising? The trees seem slightly thinner to the north, where you can see a faint glow over the canopy.",
        choices: [
          { text: "Head north towards the glow", nextStage: 'northPath' },
          { text: "Try a different direction (east)", nextStage: 'eastPathRandomEncounter' }
        ]
      },
      'followPath': {
        text: "The hidden path is narrow and winding. After a few minutes, it opens into a larger clearing. In the center stands a weathered stone shrine, covered in glowing runes. A faint humming emanates from it.",
        choices: [
          { text: "Touch the shrine", nextStage: 'touchShrine' },
          { text: "Examine the runes closely", nextStage: 'examineRunes' },
          { text: "Leave the shrine", nextStage: 'awakeningForest' }
        ]
      },
      'touchShrine': {
        text: "As your fingers brush the cold stone, the runes flare with intense light. A vision flashes through your mind: a city of silver spires, floating islands, and beings with feathered wings. The vision fades, leaving you with a sense of awe and a faint headache.",
        choices: [
          { text: "Try to understand the vision", nextStage: 'ponderVision' },
          { text: "Leave the shrine, shaken", nextStage: 'awakeningForest' }
        ]
      },
      'examineRunes': {
        text: "The runes are intricate, unlike any language you know. As you focus, some seem to shift and rearrange. If you had the 'Carved Token', perhaps you could decipher them?",
        choices: [
          { text: "Use Carved Token", nextStage: 'useTokenOnRunes', condition: () => inventory.includes('Carved Token') },
          { text: "Try to decipher without token", nextStage: 'decipherFail' },
          { text: "Leave the shrine", nextStage: 'awakeningForest' }
        ]
      },
      'useTokenOnRunes': {
        text: "You hold the Carved Token towards the runes. It resonates with the shrine's hum, and the runes glow brighter. A single, clear image forms in your mind: a map, showing a path leading from this forest to a nearby village.",
        onEnter: () => {
          showMessage("The token reveals a path!");
        },
        choices: [
          { text: "Follow the mental map to the village", nextStage: 'pathToVillage' },
          { text: "Ignore it and return to the forest", nextStage: 'awakeningForest' }
        ]
      },
      'decipherFail': {
        text: "You stare at the runes, but their meaning eludes you. They remain beautiful but incomprehensible.",
        choices: [
          { text: "Touch the shrine instead", nextStage: 'touchShrine' },
          { text: "Leave the shrine", nextStage: 'awakeningForest' }
        ]
      },
      'ponderVision': {
        text: "The vision was overwhelming. A city in the sky? Winged beings? This world is far stranger than you imagined. You feel a pull, a faint sense of direction from the vision, pointing towards the distant mountains.",
        choices: [
          { text: "Decide to head towards the mountains eventually", nextStage: 'mountainGoal' },
          { text: "Dismiss it as a hallucination", nextStage: 'awakeningForest' }
        ]
      },
      'mountainGoal': {
        text: "The vision of the sky city near the mountains feels like a significant clue. Though the path is unclear, you resolve to head towards those distant peaks when you can. For now, survival and understanding this immediate area are key.",
        choices: [
          { text: "Return to the main forest area", nextStage: 'awakeningForest' }
        ]
      },
      'northPath': {
        text: "You head north. The glow becomes brighter, and soon you break through the trees to see a small, peaceful-looking village nestled in a valley. Smoke rises from chimneys. This could be a safe haven.",
        choices: [
          { text: "Approach the village cautiously", nextStage: 'approachVillage' },
          { text: "Observe from a distance", nextStage: 'observeVillage' }
        ]
      },
      'eastPathRandomEncounter': {
        text: "You venture east. The forest grows denser. Suddenly, you stumble upon a grumpy-looking badger-like creature, twice your size, blocking your path. It snorts, eyeing you warily.",
        choices: [
          { text: "Try to sneak past", nextStage: 'sneakBadger' },
          { text: "Offer it the Shimmering Fruit", nextStage: 'offerFruitToBadger', condition: () => inventory.includes('Shimmering Fruit') },
          { text: "Slowly back away", nextStage: 'backAwayBadger' }
        ]
      },
      'offerFruitToBadger': {
        text: "You cautiously hold out the Shimmering Fruit. The badger-creature sniffs, its eyes widening slightly. It snatches the fruit and munches on it happily, then lumbers off the path, leaving it clear.",
        onEnter: () => {
          inventory = inventory.filter(item => item !== 'Shimmering Fruit');
          showMessage("The creature seemed to like the fruit!");
          updateInventoryDisplay();
        },
        choices: [
          { text: "Continue east", nextStage: 'eastPathCleared' }
        ]
      },
      'sneakBadger': {
        text: "You try to creep by, but the creature's sharp ears twitch. It lets out a loud GROWL, and you wisely decide to retreat quickly.",
        choices: [
          { text: "Go back and head north instead", nextStage: 'northPath' },
          { text: "Try another direction (west)", nextStage: 'westPathPlaceholder' }
        ]
      },
      'backAwayBadger': {
        text: "You slowly retreat. The creature watches you, then loses interest and ambles away. The path east is clear, but you feel a bit shaken.",
        choices: [
          { text: "Continue east, cautiously", nextStage: 'eastPathCleared' },
          { text: "Go back and head north instead", nextStage: 'northPath' }
        ]
      },
      'eastPathCleared': {
        text: "The path eastward eventually leads to a winding river. The water is crystal clear. You see a rickety wooden bridge further downstream.",
        choices: [
          { text: "Follow river to the bridge", nextStage: 'riverBridge' },
          { text: "Rest by the river", nextStage: 'restRiver' }
        ]
      },
      'westPathPlaceholder': {
        text: "You head west. The forest is quiet here. (This path is under construction in this story demo!)",
        choices: [
          { text: "Go back", nextStage: 'awakeningForest' }
        ]
      },
      'approachVillage': {
        text: "As you get closer, you see villagers. They look human, but are dressed in simple, rustic clothing. Some notice you and stop their work, looking curious but not hostile. An elderly woman with kind eyes steps forward.",
        choices: [
          { text: "'Hello? I seem to be lost.'", nextStage: 'villageGreetingLost' },
          { text: "Stay silent and observe them", nextStage: 'villageObserveSilent' }
        ]
      },
      'observeVillage': {
        text: "You watch from the treeline. The villagers go about their tasks – farming, mending tools. They seem peaceful. Children are playing a game with glowing pebbles. It seems safe enough.",
        choices: [
          { text: "Reveal yourself and approach", nextStage: 'approachVillage' },
          { text: "Try to find another way around", nextStage: 'villageBypassAttempt' }
        ]
      },
      'villageBypassAttempt': {
        text: "You decide to skirt around the village. The terrain becomes rough, and you realize bypassing it entirely will be difficult without getting lost.",
        choices: [
          { text: "Give up and approach the village", nextStage: 'approachVillage' },
          { text: "Continue trying to bypass", nextStage: 'awakeningForest' }
        ]
      },
      'villageGreetingLost': {
        text: "The old woman smiles. 'Lost, are you, child? You don't look to be from around here. Come, tell us your story. You look like you've traveled far.' The villagers seem welcoming.",
        choices: [
          { text: "Explain you're from another world (Risky)", nextStage: 'explainOtherWorld' },
          { text: "Say you have amnesia", nextStage: 'claimAmnesia' }
        ]
      },
      'villageObserveSilent': {
        text: "You remain silent. The villagers exchange uneasy glances. The elderly woman's smile fades slightly. 'Are you alright, dear? Can you speak?'",
        choices: [
          { text: "'I... I'm okay. Just startled.'", nextStage: 'villageGreetingLost' },
          { text: "Run away", nextStage: 'runFromVillage' }
        ]
      },
      'runFromVillage': {
        text: "Your sudden flight spooks the villagers. Some shout in alarm. You plunge back into the forest, your heart pounding. That probably wasn't the best first impression.",
        choices: [
          { text: "Try to calm down and re-evaluate", nextStage: 'awakeningForest' }
        ]
      },
      'explainOtherWorld': {
        text: "You try to explain about your world, cars, phones... The villagers listen, a mixture of confusion and awe on their faces. The elder nods slowly. 'A \"world-walker\"... It has been long since one graced our lands. You will have many questions. And we, perhaps, have some for you.'",
        choices: [
          { text: "Ask about this world", nextStage: 'askAboutThisWorld' },
          { text: "Ask how to get back", nextStage: 'askReturnHome' }
        ]
      },
      'claimAmnesia': {
        text: "You tell them you can't remember how you got here or who you are. The elder looks at you with sympathy. 'Poor child. Rest here. We will help as we can. Perhaps your memory will return.'",
        choices: [
          { text: "Accept their hospitality", nextStage: 'villageHospitality' },
          { text: "Politely decline and leave", nextStage: 'leaveVillagePolitely' }
        ]
      },
      'askAboutThisWorld': {
        text: "The elder, Elara, tells you of Aerthos, a land of magic, ancient beasts, and scattered kingdoms. She speaks of the Lumina Forest, where you awoke, and the Sky Shrines, remnants of a forgotten age. The village of Oakhaven is a peaceful place, but dangers lurk beyond its borders.",
        choices: [
          { text: "Ask about the Sky Shrines", nextStage: 'askSkyShrines' },
          { text: "Ask about dangers", nextStage: 'askDangers' },
          { text: "Thank her and rest", nextStage: 'villageHospitality' }
        ]
      },
      'askReturnHome': {
        text: "Elara's expression turns somber. 'Returning to another world... that is a magic of immense power, child. Legends speak of the Converging Paths, moments when worlds touch, but finding such a path is a quest for a lifetime, if it's possible at all.'",
        choices: [
          { text: "Ask more about Converging Paths", nextStage: 'askConvergingPaths' },
          { text: "Accept this for now and learn more about Aerthos", nextStage: 'askAboutThisWorld' }
        ]
      },
      'villageHospitality': {
        text: "You are given a warm meal and a place to rest in Oakhaven. The villagers are kind, though curious. You feel safe for the first time since arriving in Aerthos. This could be a good place to learn and plan your next move.",
        choices: [
          { text: "End of current demo path. Explore more later!", nextStage: 'endDemoVillage' }
        ]
      },
      'leaveVillagePolitely': {
        text: "You thank them for their kindness but state you need to keep moving. Elara nods understandingly. 'May your path be safe, traveler.' You leave Oakhaven behind.",
        choices: [
          { text: "Return to the forest", nextStage: 'awakeningForest' }
        ]
      },
      'askSkyShrines': {
        text: "Elara explains, 'The Sky Shrines, like the one you might have seen in the forest, are ancient. Some say they are keys, or gateways, or perhaps anchors between worlds. Their magic is not well understood now, but they hold great power.'",
        choices: [
          { text: "Could a shrine help me get back?", nextStage: 'shrineAsReturn' },
          { text: "Ask about other things", nextStage: 'askAboutThisWorld' }
        ]
      },
      'askDangers': {
        text: "'The deep woods harbor shadow-beasts, and goblins sometimes raid from the crags. The Whispering Peaks are home to drakes. But the greatest dangers are often unseen, child. Be wary.'",
        choices: [
          { text: "Thank her for the warning", nextStage: 'villageHospitality' },
          { text: "Ask about something else", nextStage: 'askAboutThisWorld' }
        ]
      },
      'askConvergingPaths': {
        text: "'The Converging Paths are not places, but moments in time, exceedingly rare, when the veil between realities thins. Ancient texts hint at rituals, or powerful artifacts that might predict or force such an event. But it is perilous knowledge.'",
        choices: [
          { text: "Vow to seek this knowledge", nextStage: 'vowSeekKnowledge' },
          { text: "Focus on survival for now", nextStage: 'villageHospitality' }
        ]
      },
      'shrineAsReturn': {
        text: "Elara considers. 'Perhaps. If one knew how to wield their power. But they can also be perilous. The one in Lumina Forest is mostly dormant, but others... they are not to be trifled with lightly.'",
        choices: [
          { text: "Decide to investigate shrines more later", nextStage: 'villageHospitality' },
          { text: "Ask about something else", nextStage: 'askAboutThisWorld' }
        ]
      },
      'vowSeekKnowledge': {
        text: "A flicker of determination lights within you. Getting home is your ultimate goal, no matter how difficult. You thank Elara, resolving to learn all you can.",
        choices: [
          { text: "Settle in Oakhaven for now", nextStage: 'villageHospitality' }
        ]
      },
      'pathToVillage': {
        text: "Following the mental map revealed by the token and shrine, you navigate the forest with newfound confidence. Soon, you arrive at the outskirts of Oakhaven village.",
        choices: [
          { text: "Approach the village", nextStage: 'approachVillage' }
        ]
      },
      'riverBridge': {
        text: "You reach a rickety wooden bridge spanning the clear river. It looks old but might hold your weight.",
        choices: [
          { text: "Cross the bridge", nextStage: 'crossBridge' },
          { text: "Look for another way", nextStage: 'findAnotherWayRiver' }
        ]
      },
      'restRiver': {
        text: "You sit by the river, the gentle sound of water soothing your nerves. You find a few edible-looking berries (not shimmering ones!) and feel slightly refreshed.",
        choices: [
          { text: "Continue to the bridge", nextStage: 'riverBridge' }
        ]
      },
      'crossBridge': {
        text: "You step cautiously onto the bridge. It creaks ominously with each step. Halfway across, a plank snaps! You stumble but manage to catch yourself, heart pounding.",
        choices: [
          { text: "Continue very carefully", nextStage: 'crossBridgeSuccess' },
          { text: "Try to go back (risky)", nextStage: 'crossBridgeBacktrackFail' }
        ]
      },
      'crossBridgeSuccess': {
        text: "With extreme care, you make it to the other side of the river, relieved. The land here seems more open, leading towards rolling hills.",
        choices: [
          { text: "Explore the rolling hills", nextStage: 'exploreHills' }
        ]
      },
      'crossBridgeBacktrackFail': {
        text: "Trying to turn back on the unstable bridge was a mistake. More planks give way, and you plunge into the cold river! You're soaked and lose any small, unsecured items (if you had any beyond key items). You manage to scramble back to the side you started on.",
        onEnter: () => {
          showMessage("You fell in the river! Soaked and lost some footing.");
        },
        choices: [
          { text: "Rest and dry off, then try bridge again", nextStage: 'riverBridge' },
          { text: "Look for another way, definitely", nextStage: 'findAnotherWayRiver' }
        ]
      },
      'findAnotherWayRiver': {
        text: "You search along the riverbank. After a while, you find a spot where the river is shallower and a fallen log forms a makeshift, if slippery, crossing.",
        choices: [
          { text: "Attempt the log crossing", nextStage: 'logCrossing' }
        ]
      },
      'logCrossing': {
        text: "The log is slippery with moss. You inch across, balancing carefully. You make it! You're on the other side, ready to explore the rolling hills.",
        choices: [
          { text: "Explore the rolling hills", nextStage: 'exploreHills' }
        ]
      },
      'exploreHills': {
        text: "The rolling hills stretch before you, dotted with wildflowers. In the distance, you see what looks like an old, ruined tower on a hilltop.",
        choices: [
          { text: "Investigate the ruined tower", nextStage: 'ruinedTowerApproach' },
          { text: "Continue through the hills", nextStage: 'hillsContinue' }
        ]
      },
      'ruinedTowerApproach': {
        text: "You make your way to the ruined tower. It's ancient, crumbling stone covered in ivy. The entrance is a dark, gaping hole. A faint, almost inaudible whisper seems to emanate from within.",
        choices: [
          { text: "Enter the tower", nextStage: 'enterTower' },
          { text: "Circle the tower exterior", nextStage: 'circleTower' },
          { text: "Leave it be", nextStage: 'hillsContinue' }
        ]
      },
      'enterTower': {
        text: "The interior is dark and dusty. Cobwebs hang like ancient curtains. In the center of the circular room, a pedestal stands empty, but an indentation suggests something was once placed there. The whispering sensation is stronger here.",
        choices: [
          { text: "Examine the pedestal", nextStage: 'examinePedestal' },
          { text: "Listen to the whispers", nextStage: 'listenWhispers' },
          { text: "Leave the tower", nextStage: 'exploreHills' }
        ]
      },
      'circleTower': {
        text: "You walk around the tower. Most of it is just crumbling stone, but on the north side, almost hidden by ivy, you find a small, locked wooden chest. It looks very old.",
        choices: [
          { text: "Try to open the chest", nextStage: 'openChest' },
          { text: "Go inside the tower", nextStage: 'enterTower' },
          { text: "Leave", nextStage: 'hillsContinue' }
        ]
      },
      'openChest': {
        text: "The lock is rusted. You try to force it. With a bit of effort, it snaps open! Inside, you find a tarnished silver locket and a small, leather-bound journal with faded, illegible script.",
        onEnter: () => {
          if (!inventory.includes('Silver Locket')) inventory.push('Silver Locket');
          if (!inventory.includes('Old Journal')) inventory.push('Old Journal');
          showMessage("Found: Silver Locket & Old Journal!");
          updateInventoryDisplay();
        },
        choices: [
          { text: "Examine the locket", nextStage: 'examineLocket' },
          { text: "Try to read the journal", nextStage: 'examineJournal' },
          { text: "Go inside the tower", nextStage: 'enterTower' }
        ]
      },
      'examineLocket': {
        text: "The silver locket is intricately engraved with swirling patterns. It doesn't open easily. Perhaps it needs a special touch or a key you don't have.",
        choices: [
          { text: "Try to read the journal", nextStage: 'examineJournal', condition: () => inventory.includes('Old Journal') },
          { text: "Keep exploring", nextStage: 'enterTower' }
        ]
      },
      'examineJournal': {
        text: "The journal's pages are brittle. The ink is faded, and the language is unknown to you. However, on one page, a crudely drawn symbol catches your eye: it's similar to the runes on the forest shrine.",
        choices: [
          { text: "Keep the journal for later", nextStage: 'enterTower' }
        ]
      },
      'examinePedestal': {
        text: "The pedestal has a circular indentation, about the size of a large coin or a small amulet. The whispers seem to emanate from this spot. If you had the 'Silver Locket', it might fit.",
        choices: [
          { text: "Place Silver Locket on pedestal", nextStage: 'placeLocket', condition: () => inventory.includes('Silver Locket') },
          { text: "Listen to the whispers", nextStage: 'listenWhispers' },
          { text: "Leave the tower", nextStage: 'exploreHills' }
        ]
      },
      'placeLocket': {
        text: "You place the Silver Locket into the indentation. It fits perfectly! The whispers intensify, then coalesce into a single, sorrowful voice: 'Freed... or perhaps... awakened... The path to the Sunken City... it begins...'",
        onEnter: () => {
          showMessage("The locket has activated something!");
        },
        choices: [
          { text: "Ask 'What Sunken City?'", nextStage: 'askSunkenCity' },
          { text: "Take the locket and leave", nextStage: 'exploreHills' }
        ]
      },
      'askSunkenCity': {
        text: "The voice fades, but before it vanishes, it imparts a fleeting vision: a city beneath the waves, glowing with an eerie light, and a path leading from a hidden cove along the coast. The locket now hums faintly.",
        choices: [
          { text: "A new goal: Find the coast!", nextStage: 'goalCoast' }
        ]
      },
      'goalCoast': {
        text: "The Sunken City... another mystery in this strange world. You resolve to find the coast and this hidden cove. The locket feels important now.",
        choices: [
          { text: "Leave the tower and head towards where you think a coast might be", nextStage: 'endDemoTower' }
        ]
      },
      'listenWhispers': {
        text: "You focus on the whispers. They are faint, indistinct, like many voices murmuring just beyond hearing. You catch fragments: '...lost...key...sunken...'. It's unsettling and gives you no clear information.",
        choices: [
          { text: "Examine the pedestal", nextStage: 'examinePedestal' },
          { text: "Leave the tower", nextStage: 'exploreHills' }
        ]
      },
      'hillsContinue': {
        text: "You decide to leave the tower for now and continue exploring the rolling hills. The landscape is vast. What now?",
        choices: [
          { text: "Search for a road or path", nextStage: 'searchRoadHills' },
          { text: "Climb the highest hill for a better view", nextStage: 'climbHillView' }
        ]
      },
      'searchRoadHills': {
        text: "After some searching, you find a barely visible dirt track. It seems to lead vaguely south.",
        choices: [
          { text: "Follow the track south", nextStage: 'followTrackSouth' }
        ]
      },
      'climbHillView': {
        text: "From the top of the highest hill, you can see for miles. To the west, the forest you came from. To the south, the hills eventually give way to what looks like a coastline. To the east, far, far in the distance, snow-capped mountains pierce the sky.",
        choices: [
          { text: "Head towards the coast (south)", nextStage: 'headToCoast' },
          { text: "Head towards the mountains (east - long journey!)", nextStage: 'headToMountainsLong' }
        ]
      },
      'followTrackSouth': {
        text: "The dirt track winds south. After an hour of walking, you see the glint of water in the distance. It's the coast!",
        choices: [
          { text: "Approach the coastline", nextStage: 'approachCoastline' }
        ]
      },
      'headToCoast': {
        text: "You decide the coast is your best bet, especially with the tower's vision in mind. You begin the trek south.",
        choices: [
          { text: "Arrive at the coastline", nextStage: 'approachCoastline' }
        ]
      },
      'headToMountainsLong': {
        text: "The mountains are a distant, ambitious goal. The journey will be long and likely perilous. For now, you make a mental note. (Path to mountains is a future adventure!)",
        choices: [
          { text: "Focus on something closer, like the coast", nextStage: 'headToCoast' }
        ]
      },
      'approachCoastline': {
        text: "You reach the coastline. A vast ocean stretches to the horizon. Salty air fills your lungs. There are cliffs, sandy beaches, and hidden coves. If the vision was true, one of these coves holds a secret.",
        choices: [
          { text: "Search for a hidden cove", nextStage: 'searchCove' },
          { text: "Walk along the beach", nextStage: 'walkBeach' }
        ]
      },
      'searchCove': {
        text: "You carefully explore the coastline, looking for anything unusual. Tucked away behind some jagged rocks, you find a narrow opening to a secluded cove. It matches the fleeting image from the tower's vision!",
        choices: [
          { text: "Enter the hidden cove", nextStage: 'enterHiddenCove' }
        ]
      },
      'walkBeach': {
        text: "You stroll along a sandy beach. Shells crunch underfoot. It's peaceful, but doesn't seem to lead to any specific clues from the tower. You do find a pretty conch shell.",
        onEnter: () => {
          if (!inventory.includes('Conch Shell')) inventory.push('Conch Shell');
          showMessage("Found a Conch Shell!");
          updateInventoryDisplay();
        },
        choices: [
          { text: "Look for a hidden cove more seriously", nextStage: 'searchCove' }
        ]
      },
      'enterHiddenCove': {
        text: "The cove is small and sheltered. At its rear, carved into the cliff face, is an ancient stone doorway, sealed shut. The air here feels heavy with old magic. The Silver Locket in your possession begins to hum louder.",
        choices: [
          { text: "Examine the stone doorway", nextStage: 'examineCoveDoor' },
          { text: "Try the Silver Locket on the door", nextStage: 'useLocketOnCoveDoor', condition: () => inventory.includes('Silver Locket') }
        ]
      },
      'examineCoveDoor': {
        text: "The stone door is massive, covered in barnacles and seaweed. There are strange symbols carved into it, different from the shrine runes but similar in style to the locket's engravings. There's no visible handle or lock mechanism.",
        choices: [
          { text: "Try the Silver Locket on the door", nextStage: 'useLocketOnCoveDoor', condition: () => inventory.includes('Silver Locket') },
          { text: "Try to force the door (unlikely)", nextStage: 'forceCoveDoor' }
        ]
      },
      'useLocketOnCoveDoor': {
        text: "You hold the Silver Locket against the door. It clicks into an unseen recess, and the symbols on the door begin to glow with an intense blue light. With a deep groan, the stone door slowly grinds open, revealing a dark passage leading down.",
        choices: [
          { text: "Enter the passage to the Sunken City", nextStage: 'enterSunkenCityPassage' }
        ]
      },
      'forceCoveDoor': {
        text: "You push and shove, but the massive stone door doesn't budge even a millimeter. It's clearly sealed by more than just its weight.",
        choices: [
          { text: "Examine the door again", nextStage: 'examineCoveDoor' }
        ]
      },
      'enterSunkenCityPassage': {
        text: "You take a deep breath and step into the darkness. The passage slopes downwards, lit by glowing moss on the walls. The air is cool and damp. The path to the Sunken City awaits... (To be continued!)",
        choices: [
          { text: "Congratulations! End of this adventure branch.", nextStage: 'endGame' }
        ]
      },
      // --- End States ---
      'endDemoVillage': {
        text: "Your adventure in Oakhaven is just beginning. There's much to explore and learn. Thanks for playing this demo branch!",
        choices: [
          { text: "Play Again?", nextStage: 'start' }
        ]
      },
      'endDemoTower': {
        text: "With the locket's guidance, a new path towards the coast and the Sunken City has opened. The mysteries of Aerthos deepen! Thanks for playing this demo branch!",
        choices: [
          { text: "Play Again?", nextStage: 'start' }
        ]
      },
      'endGame': {
        text: "You've reached a significant point in your journey. The path ahead is filled with more wonders and dangers. Thanks for playing! What will you discover next?",
        choices: [
          { text: "Play Again?", nextStage: 'start' }
        ]
      }
    };

    // --- DOM Elements ---
    const storyElement = document.getElementById('story');
    const choicesElement = document.getElementById('choices');
    const messageBox = document.getElementById('messageBox');
    const inventoryList = document.getElementById('inventoryList');

    // --- Game Logic ---
    function showMessage(message, duration = 3000) {
      messageBox.textContent = message;
      messageBox.style.display = 'block';
      setTimeout(() => {
        messageBox.style.display = 'none';
      }, duration);
    }

    function updateInventoryDisplay() {
      if (inventory.length === 0) {
        inventoryList.textContent = 'Empty';
      } else {
        inventoryList.innerHTML = inventory.map(item =>
          `<div class="inventory-item">• ${item}</div>`
        ).join('');
      }
    }

    function displayStage(stageKey) {
      const stage = storyTree[stageKey];
      if (!stage) {
        console.error("Error: Stage not found - " + stageKey);
        storyElement.textContent = "An error occurred, and the story cannot continue. Please try restarting.";
        choicesElement.innerHTML = '<button onclick="startGame()">Restart Adventure</button>';
        return;
      }

      // Execute any onEnter function for the stage
      if (stage.onEnter && typeof stage.onEnter === 'function') {
        stage.onEnter();
      }

      // Fade out, change text, fade in
      storyElement.style.animation = 'none';
      setTimeout(() => {
        storyElement.textContent = stage.text;
        storyElement.style.animation = 'textFade 0.5s ease-out';
      }, 10);

      choicesElement.innerHTML = ''; // Clear old choices

      if (stage.choices && stage.choices.length > 0) {
        stage.choices.forEach((choice, index) => {
          // Check for conditional choices
          if (choice.condition === undefined || choice.condition()) {
            const button = document.createElement('button');
            button.textContent = choice.text;
            button.style.animationDelay = `${index * 0.1}s`;
            button.style.animation = 'fadeIn 0.5s ease-out forwards';
            button.style.opacity = '0';
            button.onclick = () => {
              currentStage = choice.nextStage;
              displayStage(currentStage);
            };
            choicesElement.appendChild(button);
          }
        });
      } else {
        // If no choices, it might be an end state or an error
        const endButton = document.createElement('button');
        endButton.textContent = "The story pauses here...";
        endButton.disabled = true;
        endButton.style.opacity = '0.5';
        endButton.style.cursor = 'not-allowed';
        choicesElement.appendChild(endButton);
      }
    }

    function startGame() {
      currentStage = 'start';
      inventory = []; // Reset inventory
      updateInventoryDisplay();
      displayStage(currentStage);
    }

    // --- Initialize Game ---
    window.onload = () => {
      createParticles();
      startGame();
    };
  </script>
</body>

</html>